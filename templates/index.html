<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automated Video Processing System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .content {
            padding: 40px;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input[type="url"] {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-group input[type="url"]:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .checkbox-item:hover {
            border-color: #667eea;
            background: #f5f7ff;
        }
        
        .checkbox-item input[type="checkbox"] {
            margin-right: 8px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .checkbox-item label {
            margin: 0;
            cursor: pointer;
            font-weight: 500;
        }
        
        .subtitle-mode {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }
        
        .radio-item {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .radio-item:hover {
            border-color: #667eea;
            background: #f5f7ff;
        }
        
        .radio-item input[type="radio"] {
            margin-right: 8px;
        }
        
        .submit-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        
        .submit-btn:active {
            transform: translateY(0);
        }
        
        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .status-section {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid #e0e0e0;
        }
        
        .status-section h2 {
            margin-bottom: 20px;
            color: #333;
        }
        
        .job-card {
            background: #f5f7ff;
            border-left: 4px solid #667eea;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .job-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .job-id {
            font-weight: 600;
            color: #667eea;
        }
        
        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-queued {
            background: #ffeaa7;
            color: #d63031;
        }
        
        .status-processing {
            background: #74b9ff;
            color: #0984e3;
        }
        
        .status-completed {
            background: #55efc4;
            color: #00b894;
        }
        
        .status-failed {
            background: #ff7675;
            color: #d63031;
        }
        
        .job-details {
            font-size: 14px;
            color: #666;
            margin-top: 10px;
        }
        
        .download-links {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .download-btn {
            padding: 8px 15px;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-size: 13px;
            transition: background 0.3s;
        }
        
        .download-btn:hover {
            background: #764ba2;
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .info-box ul {
            margin-left: 20px;
            margin-top: 10px;
        }
        
        .subtitle-input-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .toggle-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .toggle-btn:hover {
            border-color: #667eea;
        }
        
        .toggle-btn.active {
            border-color: #667eea;
            background: #f5f7ff;
            color: #667eea;
        }
        
        .subtitle-input-section {
            display: none;
        }
        
        .subtitle-input-section.active {
            display: block;
        }
        
        .file-upload-area {
            border: 2px dashed #e0e0e0;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .file-upload-area:hover {
            border-color: #667eea;
            background: #f5f7ff;
        }
        
        .file-upload-area.drag-over {
            border-color: #667eea;
            background: #f5f7ff;
        }
        
        .upload-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
        
        .file-name {
            margin-top: 10px;
            color: #667eea;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé¨ Automated Video Processing System</h1>
            <p>Download, subtitle, and encode videos to multiple resolutions automatically</p>
        </div>
        
        <div class="content">
            <div class="info-box" id="systemStatus" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>üñ•Ô∏è System Status:</strong>
                        <span id="statusText">Checking...</span>
                    </div>
                    <div id="runningJobInfo" style="display: none; font-size: 12px; background: rgba(255,255,255,0.2); padding: 5px 10px; border-radius: 5px;">
                        <span id="runningJobMsg"></span>
                    </div>
                </div>
            </div>
            
            <div class="info-box">
                <strong>‚ÑπÔ∏è How it works:</strong>
                <ul>
                    <li>‚úÖ <strong>Jobs run in background</strong> - Close browser after submitting</li>
                    <li>üìä Check status anytime by reopening this page</li>
                    <li>‚ö° Only 1 job runs at a time (Railway free: 2 vCPU, 1GB RAM)</li>
                    <li>üéØ Use <strong>Soft Subtitles</strong> for production (fast!)</li>
                    <li>üé¨ Subtitles embedded + video encoded to multiple resolutions</li>
                    <li>üíæ Download processed files when complete</li>
                </ul>
            </div>
            
            <div id="alertBox"></div>
            
            <form id="processingForm" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="videoUrl">Video URL</label>
                    <input 
                        type="url" 
                        id="videoUrl" 
                        name="videoUrl" 
                        placeholder="https://example.com/video.mp4" 
                        required
                    >
                </div>
                
                <div class="form-group">
                    <label>Subtitle Input Method</label>
                    <div class="subtitle-input-toggle">
                        <button type="button" class="toggle-btn active" id="urlToggle">
                            üîó Subtitle URL
                        </button>
                        <button type="button" class="toggle-btn" id="uploadToggle">
                            üìÅ Upload File
                        </button>
                    </div>
                    
                    <!-- URL Input -->
                    <div class="subtitle-input-section active" id="urlSection">
                        <input 
                            type="url" 
                            id="subtitleUrl" 
                            name="subtitleUrl" 
                            placeholder="https://example.com/subtitle.srt"
                        >
                    </div>
                    
                    <!-- File Upload -->
                    <div class="subtitle-input-section" id="uploadSection">
                        <div class="file-upload-area" id="fileUploadArea">
                            <div class="upload-icon">üìÑ</div>
                            <div>
                                <strong>Click to browse</strong> or drag and drop
                            </div>
                            <div style="color: #666; font-size: 14px; margin-top: 5px;">
                                Supported: .srt, .ass, .vtt, .sub
                            </div>
                            <div class="file-name" id="fileName" style="display: none;"></div>
                        </div>
                        <input 
                            type="file" 
                            id="subtitleFile" 
                            name="subtitleFile" 
                            accept=".srt,.ass,.vtt,.sub,.ssa"
                            style="display: none;"
                        >
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Target Resolutions</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="res360" name="resolutions" value="360p" checked>
                            <label for="res360">360p</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="res480" name="resolutions" value="480p" checked>
                            <label for="res480">480p</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="res720" name="resolutions" value="720p" checked>
                            <label for="res720">720p</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="res1080" name="resolutions" value="1080p" checked>
                            <label for="res1080">1080p</label>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Subtitle Mode</label>
                    <div class="subtitle-mode">
                        <div class="radio-item">
                            <input type="radio" id="softSub" name="subtitleMode" value="soft" checked>
                            <label for="softSub">‚úÖ Soft Subtitle (Fast, ~1 min, Recommended)</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="hardSub" name="subtitleMode" value="hard">
                            <label for="hardSub">‚ö†Ô∏è Hard Subtitle (Very Slow, 10-30 min)</label>
                        </div>
                    </div>
                    <div id="hardSubWarning" style="display: none; background: #fff3cd; border: 1px solid #ffc107; border-radius: 5px; padding: 10px; margin-top: 10px; font-size: 13px;">
                        <strong>‚ö†Ô∏è Warning:</strong> Hard subtitles burn text into every video frame, taking 10-30 minutes and 100% CPU.
                        <br><strong>üí° Production Tip:</strong> Use Soft Subtitles for instant processing!</div>
                    </div>
                        </div>
                    </div>
                </div>
                
                <button type="submit" class="submit-btn" id="submitBtn">
                    Start Processing
                </button>
            </form>
            
            <div class="status-section" id="statusSection" style="display: block;">
                <h2>Jobs Status</h2>
                <div id="jobsList"></div>
            </div>
            
            <div class="status-section" id="fileBrowserSection" style="margin-top: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2>üìÅ File Browser (Railway Storage)</h2>
                    <button onclick="loadFileBrowser()" style="padding: 8px 15px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        üîÑ Refresh Files
                    </button>
                </div>
                <div id="fileBrowserContent" style="margin-top: 15px;">
                    <p style="color: #666; text-align: center;">Click refresh to view files on Railway server</p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let statusCheckInterval = null;
        let allJobs = [];
        let systemStatus = null;
        
        // Load all jobs and system status on page load
        window.addEventListener('load', () => {
            loadSystemStatus();
            loadAllJobs();
            startStatusCheck();
        });
        
        // Check system status
        async function loadSystemStatus() {
            try {
                const response = await fetch('/api/system/status');
                const data = await response.json();
                
                if (data.success) {
                    systemStatus = data;
                    updateSystemStatusDisplay();
                }
            } catch (error) {
                console.error('Failed to load system status:', error);
            }
        }
        
        // Update system status display
        function updateSystemStatusDisplay() {
            const statusText = document.getElementById('statusText');
            const runningJobInfo = document.getElementById('runningJobInfo');
            const runningJobMsg = document.getElementById('runningJobMsg');
            const submitBtn = document.getElementById('submitBtn');
            
            if (systemStatus.has_running_job) {
                statusText.textContent = 'üî¥ JOB RUNNING';
                statusText.style.color = '#ffd700';
                runningJobInfo.style.display = 'block';
                runningJobMsg.textContent = `Job ${systemStatus.running_job_id.slice(-8)} is processing...`;
                if (submitBtn) submitBtn.disabled = true;
            } else {
                statusText.textContent = 'üü¢ READY FOR NEW JOB';
                statusText.style.color = '#90EE90';
                runningJobInfo.style.display = 'none';
                if (submitBtn) submitBtn.disabled = false;
            }
        }
        
        // Toggle between URL and file upload
        document.getElementById('urlToggle').addEventListener('click', function() {
            document.getElementById('urlToggle').classList.add('active');
            document.getElementById('uploadToggle').classList.remove('active');
            document.getElementById('urlSection').classList.add('active');
            document.getElementById('uploadSection').classList.remove('active');
        });
        
        document.getElementById('uploadToggle').addEventListener('click', function() {
            document.getElementById('uploadToggle').classList.add('active');
            document.getElementById('urlToggle').classList.remove('active');
            document.getElementById('uploadSection').classList.add('active');
            document.getElementById('urlSection').classList.remove('active');
        });
        
        // Show warning when hard subtitle is selected
        document.getElementById('hardSub').addEventListener('change', function() {
            document.getElementById('hardSubWarning').style.display = 'block';
        });
        
        document.getElementById('softSub').addEventListener('change', function() {
            document.getElementById('hardSubWarning').style.display = 'none';
        });
        
        // File upload handling
        const fileUploadArea = document.getElementById('fileUploadArea');
        const fileInput = document.getElementById('subtitleFile');
        const fileNameDisplay = document.getElementById('fileName');
        
        fileUploadArea.addEventListener('click', () => fileInput.click());
        
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                fileNameDisplay.textContent = `‚úì ${file.name} (${(file.size / 1024).toFixed(2)} KB)`;
                fileNameDisplay.style.display = 'block';
            }
        });
        
        // Drag and drop
        fileUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUploadArea.classList.add('drag-over');
        });
        
        fileUploadArea.addEventListener('dragleave', () => {
            fileUploadArea.classList.remove('drag-over');
        });
        
        fileUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUploadArea.classList.remove('drag-over');
            const file = e.dataTransfer.files[0];
            if (file && file.name.match(/\.(srt|ass|vtt|sub|ssa)$/i)) {
                fileInput.files = e.dataTransfer.files;
                fileNameDisplay.textContent = `‚úì ${file.name} (${(file.size / 1024).toFixed(2)} KB)`;
                fileNameDisplay.style.display = 'block';
            } else {
                showAlert('Please upload a valid subtitle file (.srt, .ass, .vtt, .sub)', 'error');
            }
        });
        
        document.getElementById('processingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Check if a job is already running
            if (systemStatus && systemStatus.has_running_job) {
                showAlert('‚ö†Ô∏è A job is already running! Please wait for it to complete or cancel it first.', 'error');
                return;
            }
            
            const videoUrl = document.getElementById('videoUrl').value;
            const subtitleMode = document.querySelector('input[name="subtitleMode"]:checked').value;
            const resolutionCheckboxes = document.querySelectorAll('input[name="resolutions"]:checked');
            const resolutions = Array.from(resolutionCheckboxes).map(cb => cb.value);
            
            if (resolutions.length === 0) {
                showAlert('Please select at least one resolution', 'error');
                return;
            }
            
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = 'Submitting... <span class="spinner"></span>';
            
            try {
                // Check which subtitle method is active
                const isUrlMethod = document.getElementById('urlSection').classList.contains('active');
                
                if (isUrlMethod) {
                    // URL method - send JSON
                    const subtitleUrl = document.getElementById('subtitleUrl').value;
                    
                    if (!subtitleUrl) {
                        showAlert('Please enter subtitle URL', 'error');
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = 'Start Processing';
                        return;
                    }
                    
                    const response = await fetch('/api/submit', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            video_url: videoUrl,
                            subtitle_url: subtitleUrl,
                            resolutions: resolutions,
                            soft_subtitle: subtitleMode === 'soft'
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        showAlert(`‚úÖ Job submitted! ID: ${data.job_id.slice(-8)}. You can close this tab - job runs in background!`, 'success');
                        document.getElementById('statusSection').style.display = 'block';
                        loadSystemStatus();
                        loadAllJobs();
                    } else {
                        showAlert(`Error: ${data.error}`, 'error');
                    }
                } else {
                    // File upload method - send FormData
                    const subtitleFile = document.getElementById('subtitleFile').files[0];
                    
                    if (!subtitleFile) {
                        showAlert('Please upload a subtitle file', 'error');
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = 'Start Processing';
                        return;
                    }
                    
                    const formData = new FormData();
                    formData.append('video_url', videoUrl);
                    formData.append('subtitle_file', subtitleFile);
                    formData.append('resolutions', JSON.stringify(resolutions));
                    formData.append('soft_subtitle', subtitleMode === 'soft');
                    
                    const response = await fetch('/api/submit_with_file', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        showAlert(`‚úÖ Job submitted! ID: ${data.job_id.slice(-8)}. You can close this tab - job runs in background!`, 'success');
                        document.getElementById('statusSection').style.display = 'block';
                        loadSystemStatus();
                        loadAllJobs();
                    } else {
                        showAlert(`Error: ${data.error}`, 'error');
                    }
                }
            } catch (error) {
                showAlert(`Failed to submit job: ${error.message}`, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Start Processing';
            }
        });
        
        function showAlert(message, type) {
            const alertBox = document.getElementById('alertBox');
            const alertClass = type === 'success' ? 'alert-success' : 'alert-error';
            alertBox.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
            
            setTimeout(() => {
                alertBox.innerHTML = '';
            }, 5000);
        }
        
        async function loadAllJobs() {
            try {
                const response = await fetch('/api/jobs/all');
                const data = await response.json();
                
                if (data.success) {
                    allJobs = data.jobs;
                    updateJobsDisplay();
                }
                
                // Also refresh system status
                await loadSystemStatus();
            } catch (error) {
                console.error('Failed to load jobs:', error);
            }
        }
        
        function startStatusCheck() {
            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
            }
            
            loadAllJobs();
            statusCheckInterval = setInterval(loadAllJobs, 3000);
        }
        
        function updateJobsDisplay() {
            const jobsList = document.getElementById('jobsList');
            
            if (allJobs.length === 0) {
                jobsList.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">No jobs yet. Submit your first video processing job above!</p>';
                return;
            }
            
            jobsList.innerHTML = allJobs.map(job => createJobCard(job)).join('');
        }
        
        function createJobCard(job) {
            const details = job.details;
            const isActive = job.status === 'active';
            const isCompleted = details.status === 'completed';
            const isFailed = details.status === 'failed';
            const isCancelled = details.status === 'cancelled';
            
            let statusClass = 'status-queued';
            let statusText = details.status || 'queued';
            
            if (isActive) {
                statusClass = 'status-processing';
                statusText = 'processing';
            } else if (isCompleted) {
                statusClass = 'status-completed';
                statusText = 'completed';
            } else if (isFailed || isCancelled) {
                statusClass = 'status-failed';
                statusText = isCancelled ? 'cancelled' : 'failed';
            }
            
            // Progress bar
            let progressHTML = '';
            if (details.progress && isActive) {
                const prog = details.progress;
                const percentage = prog.percentage || 0;
                
                // Format speed
                let speedText = '';
                if (prog.speed && prog.speed > 0) {
                    const speedMB = (prog.speed / (1024 * 1024)).toFixed(2);
                    speedText = `${speedMB} MB/s`;
                }
                
                // Format ETA
                let etaText = '';
                if (prog.eta && prog.eta > 0) {
                    const minutes = Math.floor(prog.eta / 60);
                    const seconds = Math.floor(prog.eta % 60);
                    if (minutes > 0) {
                        etaText = `${minutes}m ${seconds}s remaining`;
                    } else {
                        etaText = `${seconds}s remaining`;
                    }
                }
                
                progressHTML = `
                    <div style="margin: 15px 0;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span style="font-size: 13px; color: #667eea;"><strong>${prog.task}</strong></span>
                            <span style="font-size: 13px; color: #666;">${percentage}%</span>
                        </div>
                        <div style="background: #e0e0e0; border-radius: 10px; height: 20px; overflow: hidden;">
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); height: 100%; width: ${percentage}%; transition: width 0.3s;"></div>
                        </div>
                        ${speedText || etaText ? `
                            <div style="display: flex; justify-content: space-between; margin-top: 5px; font-size: 12px; color: #666;">
                                <span>${speedText ? '‚ö° ' + speedText : ''}</span>
                                <span>${etaText ? '‚è±Ô∏è ' + etaText : ''}</span>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            // Task checklist
            let taskListHTML = '';
            if (details.tasks && details.tasks.length > 0) {
                taskListHTML = `
                    <div style="margin: 15px 0; padding: 10px; background: white; border-radius: 8px;">
                        <strong style="font-size: 14px; color: #333;">üìã Tasks:</strong>
                        <ul style="margin: 10px 0 0 20px; list-style: none; padding: 0;">
                            ${details.tasks.map(task => {
                                let icon = '‚è≥';
                                let color = '#999';
                                if (task.status === 'completed') {
                                    icon = '‚úÖ';
                                    color = '#00b894';
                                } else if (task.status === 'in-progress') {
                                    icon = '‚ñ∂Ô∏è';
                                    color = '#0984e3';
                                } else if (task.status === 'failed') {
                                    icon = '‚ùå';
                                    color = '#d63031';
                                }
                                return `<li style="padding: 5px 0; color: ${color};"><span>${icon}</span> ${task.name}</li>`;
                            }).join('')}
                        </ul>
                    </div>
                `;
            }
            
            // Output files with stream and download
            let outputHTML = '';
            if (isCompleted && details.output_files) {
                const files = details.output_files;
                outputHTML = `
                    <div style="margin-top: 15px; padding: 15px; background: white; border-radius: 8px;">
                        <strong style="color: #333;">üìπ Available Videos:</strong>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 10px;">
                            ${Object.keys(files).map(res => `
                                <div style="border: 2px solid #667eea; border-radius: 8px; padding: 10px; text-align: center;">
                                    <div style="font-weight: 600; color: #667eea; margin-bottom: 8px;">${res}</div>
                                    <a href="/api/stream/${job.job_id}/${res}" target="_blank" 
                                       style="display: block; padding: 6px; background: #667eea; color: white; text-decoration: none; border-radius: 5px; margin-bottom: 5px; font-size: 13px;">
                                        ‚ñ∂Ô∏è Stream
                                    </a>
                                    <a href="/api/download/${job.job_id}/${res}" 
                                       style="display: block; padding: 6px; background: #764ba2; color: white; text-decoration: none; border-radius: 5px; font-size: 13px;">
                                        ‚¨áÔ∏è Download
                                    </a>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Cancel button
            let cancelButton = '';
            if (isActive) {
                cancelButton = `
                    <button onclick="cancelJob('${job.job_id}')" 
                            style="padding: 8px 15px; background: #d63031; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 13px; margin-top: 10px;">
                        ‚ùå Cancel Job
                    </button>
                `;
            }
            
            return `
                <div class="job-card" style="position: relative;">
                    <div class="job-header">
                        <span class="job-id">Job: ${job.job_id}</span>
                        <span class="status-badge ${statusClass}">${statusText.toUpperCase()}</span>
                    </div>
                    <div class="job-details">
                        <div><strong>Video:</strong> ${details.video_url ? (details.video_url.length > 80 ? details.video_url.substring(0, 80) + '...' : details.video_url) : 'N/A'}</div>
                        ${details.stage ? `<div><strong>Stage:</strong> ${details.stage}</div>` : ''}
                        ${details.timestamp ? `<div><strong>Time:</strong> ${new Date(details.timestamp).toLocaleString()}</div>` : ''}
                        ${details.error ? `<div style="color: #d63031; margin-top: 10px; background: #ffe0e0; padding: 10px; border-radius: 5px;"><strong>Error:</strong> ${details.error}</div>` : ''}
                    </div>
                    ${progressHTML}
                    ${taskListHTML}
                    ${outputHTML}
                    ${cancelButton}
                </div>
            `;
        }
        
        async function cancelJob(jobId) {
            if (!confirm('Are you sure you want to cancel this job?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/jobs/cancel/${jobId}`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    showAlert('Job cancellation requested', 'success');
                    loadAllJobs();
                } else {
                    showAlert('Failed to cancel job: ' + data.error, 'error');
                }
            } catch (error) {
                showAlert('Error cancelling job: ' + error.message, 'error');
            }
        }
        
        // File browser functionality
        async function loadFileBrowser() {
            const content = document.getElementById('fileBrowserContent');
            content.innerHTML = '<p style="text-align: center; color: #667eea;">Loading files...</p>';
            
            try {
                const response = await fetch('/api/files/browse');
                const data = await response.json();
                
                if (data.success) {
                    displayFiles(data.files);
                } else {
                    content.innerHTML = `<p style="color: #d63031;">Error: ${data.error}</p>`;
                }
            } catch (error) {
                content.innerHTML = `<p style="color: #d63031;">Failed to load files: ${error.message}</p>`;
            }
        }
        
        function displayFiles(files) {
            const content = document.getElementById('fileBrowserContent');
            
            let html = `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <strong>üíæ Total Storage:</strong> ${files.total_size_mb} MB (${files.total_size_gb} GB)
                    <br><small style="color: #666;">‚ö†Ô∏è Railway storage is ephemeral - files are deleted on restart/redeploy</small>
                </div>
            `;
            
            // Downloads folder
            if (files.downloads.length > 0) {
                html += `
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #667eea; margin-bottom: 10px;">üì• Downloads Folder (${files.downloads.length} files)</h3>
                        <div style="background: white; border-radius: 8px; overflow: hidden;">
                            ${files.downloads.map(file => `
                                <div style="padding: 12px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; color: #333;">${file.name}</div>
                                        <div style="font-size: 12px; color: #666;">
                                            ${file.size_mb} MB ‚Ä¢ ${new Date(file.modified).toLocaleString()}
                                        </div>
                                    </div>
                                    <a href="/api/files/download/${encodeURIComponent(file.path)}" 
                                       style="padding: 8px 15px; background: #667eea; color: white; text-decoration: none; border-radius: 5px; font-size: 13px;">
                                        ‚¨áÔ∏è Download
                                    </a>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Outputs folder by resolution
            const resolutions = Object.keys(files.outputs);
            if (resolutions.length > 0) {
                html += `<h3 style="color: #667eea; margin-bottom: 10px;">üé¨ Output Videos</h3>`;
                
                resolutions.forEach(resolution => {
                    const resFiles = files.outputs[resolution];
                    if (resFiles.length > 0) {
                        html += `
                            <div style="margin-bottom: 15px;">
                                <h4 style="color: #764ba2; margin-bottom: 8px;">${resolution} (${resFiles.length} files)</h4>
                                <div style="background: white; border-radius: 8px; overflow: hidden;">
                                    ${resFiles.map(file => `
                                        <div style="padding: 12px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center;">
                                            <div style="flex: 1;">
                                                <div style="font-weight: 600; color: #333;">${file.name}</div>
                                                <div style="font-size: 12px; color: #666;">
                                                    ${file.size_mb} MB ‚Ä¢ ${new Date(file.modified).toLocaleString()}
                                                </div>
                                            </div>
                                            <div style="display: flex; gap: 8px;">
                                                <a href="/api/stream/${file.path.split('/').slice(-2)[0]}/${resolution}" 
                                                   style="padding: 8px 15px; background: #667eea; color: white; text-decoration: none; border-radius: 5px; font-size: 13px;">
                                                    ‚ñ∂Ô∏è Stream
                                                </a>
                                                <a href="/api/files/download/${encodeURIComponent(file.path)}" 
                                                   style="padding: 8px 15px; background: #764ba2; color: white; text-decoration: none; border-radius: 5px; font-size: 13px;">
                                                    ‚¨áÔ∏è Download
                                                </a>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }
                });
            }
            
            if (files.downloads.length === 0 && resolutions.length === 0) {
                html += '<p style="text-align: center; color: #666; padding: 40px;">No files found. Complete a job to see files here.</p>';
            }
            
            content.innerHTML = html;
        }
    </script>
</body>
</html>
